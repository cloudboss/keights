---
- name: set keights version
  set_fact:
    keights_version: '{{ item }}'
  with_file:
    - '{{ role_path }}/version'

- name: set default values
  set_fact:
    cluster_dns: '{{ keights_stack.masters.service_cidr.split(".")[:-1] | join(".") }}.10'
    default_etcd_domain: '{{ "{}.local".format(keights_stack.cluster_name) }}'
    etcd_device: '{{ keights_stack.masters.etcd_device | default("xvdg") }}'
    k8s_version: '{{ keights_stack.k8s_version | default(keights_version.split("-")[0]) }}'
    default_image: 'debian-stretch-k8s-hvm-amd64-{{ keights_version }}'
    cache_dir: '{{ playbook_dir }}/.cache'
    default_docker_options:
      'ip-masq': false
      'iptables': false
      'log-driver': journald
      'storage-driver': overlay2

- name: ensure cache directory
  file:
    path: '{{ cache_dir }}'
    state: directory

- name: find ami
  ec2_ami_facts:
    owners: '{{ keights_stack.image_owner | default("256008164056") }}'
    filters:
      name: '{{ keights_stack.image | default(default_image) }}'
  register: ami
  when: keights_stack.lookup_image | default(lookup_image)

- name: assert that at least one ami is found
  assert:
    that: ami.images | length > 0
    msg: 'expected to find at least one ami with name {{ keights_stack.image | default(default_image) }}'
  when: keights_stack.lookup_image | default(lookup_image)

- name: assert the correct number of master subnet ids
  assert:
    that: keights_stack.masters.subnet_ids | length in (1, 3)
    msg: 'expected to be given 1 or 3 master subnet ids, got {{ keights_stack.masters.subnet_ids | length }}'

- name: set image id
  set_fact:
    image_id: '{{ ami.images[0].image_id }}'
  when: keights_stack.lookup_image | default(lookup_image)

- name: find lambda archives in s3
  aws_s3:
    bucket: '{{ keights_stack.resource_bucket }}'
    object: 'stackbot/{{ item }}/{{ keights_version }}/go1.x/{{ item }}-{{ keights_version }}.zip'
    mode: geturl
  register: stackbots
  loop:
    - auto_namer
    - instattr
    - kube_ca
    - subnet_to_az
  changed_when: false
  failed_when: false
  tags:
    - lambda

- name: download lambda archives releases
  get_url:
    url: https://github.com/cloudboss/keights/releases/download/{{ keights_version }}/{{ item.item }}-{{ keights_version }}.zip
    dest: '{{ cache_dir }}'
  loop: '{{ stackbots.results }}'
  when: '"url" not in item'
  tags:
    - lambda

- name: upload lambda archives to s3
  aws_s3:
    bucket: '{{ keights_stack.resource_bucket }}'
    object: 'stackbot/{{ item.item }}/{{ keights_version }}/go1.x/{{ item.item }}-{{ keights_version }}.zip'
    mode: put
    src: '{{ cache_dir }}/{{ item.item }}-{{ keights_version }}.zip'
  loop: '{{ stackbots.results }}'
  when: '"url" not in item'
  tags:
    - lambda

- name: build common stack
  cloudformation:
    stack_name: '{{ keights_stack.cluster_name }}-common'
    role_arn: '{{ keights_stack.cfn_role_arn | default(omit) }}'
    template: '{{ role_path }}/files/common.yml'
    template_parameters:
      VpcId: '{{ keights_stack.vpc_id }}'
      ClusterName: '{{ keights_stack.cluster_name }}'
      EtcdDomain: '{{ keights_stack.etcd_domain | default(default_etcd_domain) }}'
      EtcdHostedZoneId: '{{ keights_stack.etcd_hosted_zone_id | default("") }}'
      KmsKeyId: '{{ keights_stack.kms_key_id }}'
      ApiAccessCidr: '{{ keights_stack.api_access_cidr }}'
      # TODO: give masters and nodes separate ssh_access_cidr
      SshAccessCidr: '{{ keights_stack.ssh_access_cidr }}'
      KeightsVersion: '{{ keights_version }}'
      ResourceBucket: '{{ keights_stack.resource_bucket }}'
    tags:
      KubernetesCluster: '{{ keights_stack.cluster_name }}'
      k8s:version: '{{ k8s_version }}'
      keights:version: '{{ keights_version }}'
  register: common_stack
  tags:
    - common

- name: build master stack
  cloudformation:
    stack_name: '{{ keights_stack.cluster_name }}-master'
    role_arn: '{{ keights_stack.cfn_role_arn | default(omit) }}'
    template: '{{ role_path }}/files/master.yml'
    template_parameters:
      ClusterName: '{{ keights_stack.cluster_name }}'
      NumInstances: '{{ keights_stack.masters.subnet_ids | length }}'
      VpcId: '{{ keights_stack.vpc_id }}'
      SubnetIds: '{{ keights_stack.masters.subnet_ids | join(",") }}'
      LoadBalancerSubnetIds: '{{ keights_stack.masters.subnet_ids | join(",") }}'
      ImageId: '{{ keights_stack.masters.image_id if keights_stack.masters.image_id is defined else image_id }}'
      InstanceType: '{{ keights_stack.masters.instance_type }}'
      KeyPair: '{{ keights_stack.masters.keypair }}'
      MasterInstanceProfile: '{{ common_stack.stack_outputs.MasterInstanceProfile }}'
      LoadBalancerScheme: '{{ keights_stack.masters.load_balancer_scheme }}'
      LoadBalancerSecurityGroup: '{{ common_stack.stack_outputs.LoadBalancerSecurityGroup }}'
      LoadBalancerIdleTimeout: '{{ keights_stack.masters.load_balancer_idle_timeout | default(600) }}'
      MasterSecurityGroups: '{{ ([common_stack.stack_outputs.MasterSecurityGroup] + keights_stack.masters.extra_security_groups | default([])) | join(",") }}'
      LambdaRoleArn: '{{ common_stack.stack_outputs.LambdaRoleArn }}'
      InstanceAttributeFunctionArn: '{{ common_stack.stack_outputs.InstanceAttributeFunctionArn }}'
      KmsKeyId: '{{ keights_stack.kms_key_alias }}'
      PodCidr: '{{ keights_stack.masters.pod_cidr }}'
      ServiceCidr: '{{ keights_stack.masters.service_cidr }}'
      ClusterDns: '{{ cluster_dns }}'
      ClusterDomain: '{{ keights_stack.cluster_domain | default("cluster.local") }}'
      EtcdDomain: '{{ keights_stack.etcd_domain | default(default_etcd_domain) }}'
      EtcdPrefix: '{{ keights_stack.etcd_prefix | default("etcd") }}'
      EtcdVolumeSize: '{{ keights_stack.masters.etcd_volume_size | default(10) }}'
      EtcdDevice: '{{ etcd_device }}'
      EtcdInternalDevice: '{{ etcd_device if etcd_device.startswith("/dev/") else "/dev/{}".format(etcd_device) }}'
      ImageRepository: '{{ keights_stack.masters.image_repository | default("k8s.gcr.io") }}'
      KubernetesVersion: '{{ k8s_version }}'
      KeightsVersion: '{{ keights_version }}'
      ResourceBucket: '{{ keights_stack.resource_bucket }}'
      HostedZoneId: '{{ common_stack.stack_outputs.HostedZoneId | default(keights_stack.etcd_hosted_zone_id) }}'
      # Piping to_json twice escapes the json so it can be put on one line in the CloudFormation template.
      DockerOptions: '{{ keights_stack.masters.docker_options | default(default_docker_options) | to_nice_json | to_json }}'
    tags:
      KubernetesCluster: '{{ keights_stack.cluster_name }}'
      k8s:version: '{{ k8s_version }}'
      keights:version: '{{ keights_version }}'
  register: master_stack
  tags:
    - master

- name: build node stack
  cloudformation:
    stack_name: '{{ keights_stack.cluster_name }}-node-{{ item.name }}'
    role_arn: '{{ keights_stack.cfn_role_arn | default(omit) }}'
    template: '{{ role_path }}/files/node.yml'
    template_parameters:
      ClusterName: '{{ keights_stack.cluster_name }}'
      MinInstances: '{{ item.min_instances }}'
      MaxInstances: '{{ item.max_instances }}'
      UpdateMaxBatchSize: '{{ item.update_max_batch_size | default(1) }}'
      VpcId: '{{ keights_stack.vpc_id }}'
      SubnetIds: '{{ item.subnet_ids | join(",") }}'
      ImageId: '{{ item.image_id if item.image_id is defined else image_id }}'
      InstanceType: '{{ item.instance_type }}'
      KeyPair: '{{ item.keypair }}'
      NodeInstanceProfile: '{{ common_stack.stack_outputs.NodeInstanceProfile }}'
      NodeSecurityGroups: '{{ ([common_stack.stack_outputs.NodeSecurityGroup] + item.extra_security_groups | default([])) | join(",") }}'
      InstanceAttributeFunctionArn: '{{ common_stack.stack_outputs.InstanceAttributeFunctionArn }}'
      ClusterDns: '{{ cluster_dns }}'
      NodeLabels: '{% set j = joiner(",") %}{% for k, v in item.node_labels.items() | default({}) %}{{ j() }}{{ k }}={{ v }}{% endfor %}'
      LoadBalancerDnsName: '{{ master_stack.stack_outputs.LoadBalancerDnsName }}'
      ImageRepository: '{{ item.image_repository | default("k8s.gcr.io") }}'
      DockerOptions: '{{ item.docker_options | default(default_docker_options) | to_nice_json | to_json }}'
    tags:
      KubernetesCluster: '{{ keights_stack.cluster_name }}'
      k8s:version: '{{ k8s_version }}'
      keights:version: '{{ keights_version }}'
  loop: '{{ keights_stack.node_groups }}'
  tags:
    - nodes
